<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Get Map Objects</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='config.js'></script>
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<script src='leaflet-realtime.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>

<style>
.filter-ui {
  background:#fff;
  position:absolute;
  top:10px;
  right:10px;
  z-index:100;
  padding:10px;
  border-radius:3px;
  }
</style>

<nav id='filters' class='filter-ui'></nav>

<div id='map'></div>

<script>
L.mapbox.accessToken = window.MAPBOX_API_KEY;
var map = L.mapbox.map('map', 'mapbox.streets');
var filters = document.getElementById('filters');

var realtime = L.realtime({url: 'get_map_objects.json', type: 'json'}, {
  interval: 10 * 1000,
  pointToLayer: L.mapbox.marker.style,
  style: function(feature) { return feature.properties; },
  filter: function(feature) {
    if (!loaded) {
      return true;
    }

    var enabled = {};
    for (var i = 0; i < checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        enabled[checkboxes[i].id] = true;
      }
    }
    return (feature.properties['marker-symbol'] in enabled);
  },
  onEachFeature: function (feature, layer) {
    layer.bindPopup(feature.properties.title);
  }
}).addTo(map);

var checkboxes = [];
var loaded = false;
realtime.on('update', function(updateEvent) {
  if(!loaded) {
    loaded = true;
    //Set the view after the first load
    map.fitBounds(realtime.getBounds(), {maxZoom: 16});

    var typesObj = {}, types = [];
    var features = updateEvent.features
    for (prop in features) {
      typesObj[features[prop].properties['marker-symbol']] = true;
    }
    for (var k in typesObj) types.push(k);

    for (var i = 0; i < types.length; i++) {
      var item = filters.appendChild(document.createElement('div'));
      var checkbox = item.appendChild(document.createElement('input'));
      var label = item.appendChild(document.createElement('label'));
      checkbox.type = 'checkbox';
      checkbox.id = types[i];
      checkbox.checked = true;
      label.innerHTML = types[i];
      label.setAttribute('for', types[i]);
      checkboxes.push(checkbox);
    }
  }
});

</script>

</body>
</html>

